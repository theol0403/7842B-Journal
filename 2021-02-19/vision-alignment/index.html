<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="IE=Edge" /> <meta name="theme-color" content="#94ddff" /> <meta http-equiv="cache-control" content="no-cache" /> <meta http-equiv="expires" content="0" /> <meta http-equiv="pragma" content="no-cache" /> <title>Vision Alignment - 7842B Journal</title> <link rel="shortcut icon" href="https://theol0403.github.io/7842B-Journal/assets/images/favicon.ico" type="image/x-icon" /> <link rel="stylesheet" href="https://theol0403.github.io/7842B-Journal/assets/css/just-the-docs.css" /> <script type="text/javascript" src="https://theol0403.github.io/7842B-Journal/assets/js/vendor/lunr.min.js" ></script> <script type="text/javascript" src="https://theol0403.github.io/7842B-Journal/assets/js/just-the-docs.js" ></script> <meta name="viewport" content="width=device-width, initial-scale=1" /> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Vision Alignment | 7842B Journal</title> <meta name="generator" content="Jekyll v4.2.0" /> <meta property="og:title" content="Vision Alignment" /> <meta name="author" content="Theo Lemay" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Table of contents" /> <meta property="og:description" content="Table of contents" /> <link rel="canonical" href="https://theol0403.github.io/7842B-Journal/2021-02-19/vision-alignment/" /> <meta property="og:url" content="https://theol0403.github.io/7842B-Journal/2021-02-19/vision-alignment/" /> <meta property="og:site_name" content="7842B Journal" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2021-02-19T00:00:00+00:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Vision Alignment" /> <script type="application/ld+json"> {"@type":"BlogPosting","description":"Table of contents","mainEntityOfPage":{"@type":"WebPage","@id":"https://theol0403.github.io/7842B-Journal/2021-02-19/vision-alignment/"},"author":{"@type":"Person","name":"Theo Lemay"},"url":"https://theol0403.github.io/7842B-Journal/2021-02-19/vision-alignment/","headline":"Vision Alignment","dateModified":"2021-02-19T00:00:00+00:00","datePublished":"2021-02-19T00:00:00+00:00","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="link" viewBox="0 0 16 16"> <title>Link</title> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path> </symbol> </svg> <div class="page-wrap"> <div class="side-bar"> <div class="site-header"> <a href="https://theol0403.github.io/7842B-Journal" class="site-title lh-tight"><span class="bteam">7842B</span>&nbsp;Journal </a> <button class="menu-button fs-3 js-main-nav-trigger" data-text-toggle="Hide" type="button">Menu</button> </div> <div class="navigation main-nav js-main-nav"> <nav role="navigation" aria-label="Main navigation"> <ul class="navigation-list"><li class="navigation-list-item"><a href="https://theol0403.github.io/7842B-Journal/404.html" class="navigation-list-link"></a></li><li class="navigation-list-item"><a href="https://theol0403.github.io/7842B-Journal/" class="navigation-list-link">Home</a><ul class="navigation-list-child-list "></ul></li><li class="navigation-list-item active"><a href="https://theol0403.github.io/7842B-Journal/programming" class="navigation-list-link">Programming</a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="https://theol0403.github.io/7842B-Journal/programming/skills" class="navigation-list-link">Skills</a><ul class="navigation-list-child-list"><li class="navigation-list-item "> <a href="https://theol0403.github.io/7842B-Journal/2021-02-04/v1-skills/" class="navigation-list-link">V1 Skills</a> </li><li class="navigation-list-item "> <a href="https://theol0403.github.io/7842B-Journal/2021-03-01/v2-skills/" class="navigation-list-link">V2 Skills</a> </li><li class="navigation-list-item "> <a href="https://theol0403.github.io/7842B-Journal/2021-04-03/v3-skills/" class="navigation-list-link">V3 Skills</a> </li></ul></li><li class="navigation-list-item "><a href="https://theol0403.github.io/7842B-Journal/programming/intake" class="navigation-list-link">Intake Automation</a><ul class="navigation-list-child-list"><li class="navigation-list-item "> <a href="https://theol0403.github.io/7842B-Journal/2021-02-20/intake-log-1/" class="navigation-list-link">Intake Log 1</a> </li><li class="navigation-list-item "> <a href="https://theol0403.github.io/7842B-Journal/2021-03-24/intake-log-2/" class="navigation-list-link">Intake Log 2</a> </li></ul></li><li class="navigation-list-item active"><a href="https://theol0403.github.io/7842B-Journal/programming/motion" class="navigation-list-link">Motion Control</a><ul class="navigation-list-child-list"><li class="navigation-list-item "> <a href="https://theol0403.github.io/7842B-Journal/2020-06-01/introduction/" class="navigation-list-link">Introduction</a> </li><li class="navigation-list-item "> <a href="https://theol0403.github.io/7842B-Journal/2020-06-22/trajectory-journal/" class="navigation-list-link">Trajectory Journal</a> </li><li class="navigation-list-item "> <a href="https://theol0403.github.io/7842B-Journal/2020-12-10/trajectory-log-1/" class="navigation-list-link">Trajectory Log 1</a> </li><li class="navigation-list-item "> <a href="https://theol0403.github.io/7842B-Journal/2021-02-15/trajectory-log-2/" class="navigation-list-link">Trajectory Log 2</a> </li><li class="navigation-list-item "> <a href="https://theol0403.github.io/7842B-Journal/2021-03-02/trajectory-log-3/" class="navigation-list-link">Trajectory Log 3</a> </li><li class="navigation-list-item active"> <a href="https://theol0403.github.io/7842B-Journal/2021-02-19/vision-alignment/" class="navigation-list-link active">Vision Alignment</a> </li></ul></li></ul></li><li class="navigation-list-item"><a href="https://theol0403.github.io/7842B-Journal/build" class="navigation-list-link">Build</a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="https://theol0403.github.io/7842B-Journal/2021-01-28/driver-skills/" class="navigation-list-link">Driver Skills</a></li><li class="navigation-list-item "><a href="https://theol0403.github.io/7842B-Journal/build/v1/" class="navigation-list-link">Robot V1</a><ul class="navigation-list-child-list"><li class="navigation-list-item "> <a href="https://theol0403.github.io/7842B-Journal/2021-01-20/intakes/" class="navigation-list-link">Intake Design</a> </li><li class="navigation-list-item "> <a href="https://theol0403.github.io/7842B-Journal/2021-01-15/chassis/" class="navigation-list-link">Robot Chassis</a> </li></ul></li><li class="navigation-list-item "><a href="https://theol0403.github.io/7842B-Journal/build/v2/" class="navigation-list-link">Robot V2</a><ul class="navigation-list-child-list"><li class="navigation-list-item "> <a href="https://theol0403.github.io/7842B-Journal/2021-02-28/upgrades/" class="navigation-list-link">Upgrades</a> </li><li class="navigation-list-item "> <a href="https://theol0403.github.io/7842B-Journal/2021-02-26/hood-changes/" class="navigation-list-link">Hood Changes</a> </li><li class="navigation-list-item "> <a href="https://theol0403.github.io/7842B-Journal/2021-02-23/deflector/" class="navigation-list-link">Deflector</a> </li></ul></li><li class="navigation-list-item "><a href="https://theol0403.github.io/7842B-Journal/build/v3/" class="navigation-list-link">Robot V3</a><ul class="navigation-list-child-list"><li class="navigation-list-item "> <a href="https://theol0403.github.io/7842B-Journal/2021-04-02/hood-catapult/" class="navigation-list-link">Hood Catapult</a> </li><li class="navigation-list-item "> <a href="https://theol0403.github.io/7842B-Journal/2021-03-29/intake-changes/" class="navigation-list-link">Intake changes</a> </li><li class="navigation-list-item "> <a href="https://theol0403.github.io/7842B-Journal/2021-03-26/roller-changes/" class="navigation-list-link">Roller changes</a> </li></ul></li></ul></li><li class="navigation-list-item"><a href="https://theol0403.github.io/7842B-Journal/archive" class="navigation-list-link">Archive</a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="https://theol0403.github.io/7842B-Journal/2019-11-28/lib7842/" class="navigation-list-link">lib7842</a></li><li class="navigation-list-item "><a href="https://theol0403.github.io/7842B-Journal/2019-11-25/pure-pursuit/" class="navigation-list-link">Pure Pursuit</a></li><li class="navigation-list-item "><a href="https://theol0403.github.io/7842B-Journal/2019-11-20/odom-x-controller/" class="navigation-list-link">Odom X Controller</a></li><li class="navigation-list-item "><a href="https://theol0403.github.io/7842B-Journal/2019-11-15/odom-controller/" class="navigation-list-link">Odom Controller</a></li><li class="navigation-list-item "><a href="https://theol0403.github.io/7842B-Journal/2019-11-10/tests/" class="navigation-list-link">Unit Tests</a></li><li class="navigation-list-item "><a href="https://theol0403.github.io/7842B-Journal/2019-10-19/gui/" class="navigation-list-link">GUI</a></li><li class="navigation-list-item "><a href="https://theol0403.github.io/7842B-Journal/2019-10-18/task-wrapper/" class="navigation-list-link">Task Wrapper</a></li><li class="navigation-list-item "><a href="https://theol0403.github.io/7842B-Journal/2019-10-16/statemachine/" class="navigation-list-link">State Machine</a></li><li class="navigation-list-item "><a href="https://theol0403.github.io/7842B-Journal/2019-10-15/motion-algorithms/" class="navigation-list-link">Motion Algorithms</a></li><li class="navigation-list-item "><a href="https://theol0403.github.io/7842B-Journal/2019-08-19/robot-showcase/" class="navigation-list-link">2018-19 Showcase</a></li></ul></li></ul> </nav> </div> </div> <div class="main-content-wrap js-main-content" tabindex="0"> <div class="main-content "> <div class="page-header js-page-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" class="js-search-input search-input" tabindex="0" placeholder="Search 7842B Journal" aria-label="Search 7842B Journal" autocomplete="off"> <svg width="14" height="14" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg" class="search-icon"><title>Search</title><g fill-rule="nonzero"><path d="M17.332 20.735c-5.537 0-10-4.6-10-10.247 0-5.646 4.463-10.247 10-10.247 5.536 0 10 4.601 10 10.247s-4.464 10.247-10 10.247zm0-4c3.3 0 6-2.783 6-6.247 0-3.463-2.7-6.247-6-6.247s-6 2.784-6 6.247c0 3.464 2.7 6.247 6 6.247z"/><path d="M11.672 13.791L.192 25.271 3.02 28.1 14.5 16.62z"/></g></svg> </div> <div class="js-search-results search-results-wrap"></div> </div> <ul class="list-style-none text-small aux-nav"> <li class="d-inline-block my-0 mr-2"><a href="https://theol0403.github.io/7842B-Journal/build">Build</a></li> <li class="d-inline-block my-0"><a href="https://theol0403.github.io/7842B-Journal/programming">Programming</a></li> </ul> </div> <div class="page"> <nav class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="https://theol0403.github.io/7842B-Journal/programming">Programming</a></li> <li class="breadcrumb-nav-list-item"><a href="https://theol0403.github.io/7842B-Journal/programming/motion">Motion Control</a></li> <li class="breadcrumb-nav-list-item"><span>Vision Alignment</span></li> </ol> </nav> <div id="main-content" class="page-content" role="main"> <h1> <a href="https://theol0403.github.io/7842B-Journal/2021-02-19/vision-alignment/"> Vision Alignment </a> - February 19, 2021 </h1> <span class="author">Theo Lemay</span> <article><!-- prettier-ignore-start --> <h2 class="no_toc text-delta" id="table-of-contents"> <a href="#table-of-contents" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Table of contents </h2> <ol id="markdown-toc"> <li><a href="#motivation" id="markdown-toc-motivation">Motivation</a></li> <li><a href="#filtering" id="markdown-toc-filtering">Filtering</a></li> <li><a href="#motion-control" id="markdown-toc-motion-control">Motion Control</a></li> <li><a href="#update-feb-24" id="markdown-toc-update-feb-24">Update Feb 24</a></li> <li><a href="#update-feb-30" id="markdown-toc-update-feb-30">Update Feb 30</a></li> </ol> <!-- prettier-ignore-end --> <h2 id="motivation"> <a href="#motivation" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Motivation </h2> <p>Even though V1 skills worked decently well, the greatest point of failure was picking up the balls.</p> <p>This is because even though the linear motions were very smooth and consistent, the PID IMU point turns have a few degrees of unpredictable error. One solution is to employ the use of more sensors.</p> <p>The VEX vision sensor is perfect for this task: align with the balls when driving to increase consistency. If the vision sensor is angled down so the tiles act as a background, there will be very little interference, and the sensor does not need to be able to see very far.</p> <h2 id="filtering"> <a href="#filtering" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Filtering </h2> <p>The vision sensor is quite noisy and inconsistent. Also, working with the objects concisely is a challenging task. Therefore, I developed an API for lib7842 to make it easy to work with vision objects.</p> <p>The code used on the robot is:</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// read the sensor</span>
<span class="k">auto</span> <span class="n">container</span> <span class="o">=</span> <span class="n">vision</span><span class="o">-&gt;</span><span class="n">getAll</span><span class="p">().</span><span class="n">sort</span><span class="p">(</span><span class="n">Vision</span><span class="o">::</span><span class="n">Query</span><span class="o">::</span><span class="n">area</span><span class="p">);</span>

<span class="c1">// remove noise (super small objects) and unusable (full screen) objects</span>
<span class="n">container</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">Vision</span><span class="o">::</span><span class="n">Query</span><span class="o">::</span><span class="n">area</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">less</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(),</span> <span class="mi">3000</span><span class="p">)</span>
  <span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">Vision</span><span class="o">::</span><span class="n">Query</span><span class="o">::</span><span class="n">area</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">greater</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(),</span> <span class="mi">34000</span><span class="p">);</span>

<span class="c1">// clear the rendering surface on the screen</span>
<span class="n">drawer</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
<span class="c1">// draw the objects onto the screen</span>
<span class="n">drawer</span><span class="o">-&gt;</span><span class="n">makeLayer</span><span class="p">()</span>
  <span class="p">.</span><span class="n">withColor</span><span class="p">(</span><span class="n">LV_COLOR_RED</span><span class="p">,</span> <span class="n">LV_COLOR_BLACK</span><span class="p">,</span> <span class="n">RED</span><span class="p">)</span>
  <span class="p">.</span><span class="n">withColor</span><span class="p">(</span><span class="n">LV_COLOR_BLUE</span><span class="p">,</span> <span class="n">LV_COLOR_BLACK</span><span class="p">,</span> <span class="n">BLUE</span><span class="p">)</span>
  <span class="p">.</span><span class="n">draw</span><span class="p">(</span><span class="n">container</span><span class="p">);</span>

<span class="c1">// extract the red balls, and get the position of the largest object relative to the center of the screen</span>
<span class="k">auto</span> <span class="n">reds</span> <span class="o">=</span> <span class="n">container</span><span class="p">;</span>
<span class="n">offset</span> <span class="o">=</span> <span class="n">reds</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">Vision</span><span class="o">::</span><span class="n">Query</span><span class="o">::</span><span class="n">sig</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">not_equal_to</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(),</span> <span class="n">RED</span><span class="p">)</span>
           <span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vision</span><span class="o">::</span><span class="n">Query</span><span class="o">::</span><span class="n">offsetCenterX</span><span class="p">);</span>

<span class="c1">// extract the blue balls, and get the position of the largest object relative to the center of the screen</span>
<span class="k">auto</span> <span class="n">blues</span> <span class="o">=</span> <span class="n">container</span><span class="p">;</span>
<span class="n">blueOffset</span> <span class="o">=</span> <span class="n">blues</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">Vision</span><span class="o">::</span><span class="n">Query</span><span class="o">::</span><span class="n">sig</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">not_equal_to</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(),</span> <span class="n">BLUE</span><span class="p">)</span>
               <span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vision</span><span class="o">::</span><span class="n">Query</span><span class="o">::</span><span class="n">offsetCenterX</span><span class="p">);</span>
</code></pre></div></div> <h2 id="motion-control"> <a href="#motion-control" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Motion Control </h2> <p>Next, I need to use the vision data to align the robot. To do this, I use the x coordinate relative to the center of the screen and feed it into a p loop.</p> <p>That P loop then gets combined with the velocities from the trajectory generator to gently correct the motion.</p> <p>It works great on the robot!</p> <h2 id="update-feb-24"> <a href="#update-feb-24" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Update Feb 24 </h2> <p>At the competition, it worked very well! The robot was able to much more consistently grab the balls. Here is the full run:</p> <iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/xOU6WEcxbS0" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe> <h2 id="update-feb-30"> <a href="#update-feb-30" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Update Feb 30 </h2> <p>The main issue with the vision seeking is that it introduces variability and causes the endpoint of a trajectory to be unknown, especially if the robot had to aggressively compensate to grab a ball.</p> <p>We had the idea of modifying the correction to strafe instead of turn, which would result in less damage being done on the final pose. This, along with the newly improved trajectory generator, worked together very nicely:</p> <iframe width="560" height="315" src="https://www.youtube.com/embed/9Ip8POgMptk" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe> </article> <hr> <footer role="contentinfo"> <p class="text-small text-grey-dk-000 mb-0">Copyright &copy; 2020-2021</p> </footer> </div> </div> </div> </div> </body> </html> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
